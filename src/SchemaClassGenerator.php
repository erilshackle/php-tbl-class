<?php


namespace Eril\TblClass;

use PDO;

class SchemaClassGenerator extends Generator
{
    public function __construct(PDO $pdo, Config $config, bool $checkMode = false)
    {
        parent::__construct($pdo, $config, $checkMode, 'schema');
        $this->mode = 'schema';
    }

    protected function generateContent(
        array $tables,
        array $foreignKeys = [],
        ?string $schemaHash = null
    ): string {
        $content  = "<?php\n\n";
        $content .= $this->generateHeader($schemaHash);
        $content .= $this->generateTblClass($tables);
        $content .= $this->generateTableClasses($tables);
        $content .= "\n// auto-generated by tbl-class v3\n";

        return $content;
    }

    private function generateHeader(string $schemaHash): string
    {
        return <<<PHP
/**
 * Database schema classes
 *
 * @schema-hash md5:$schemaHash
 * @generated   {date('Y-m-d H:i:s')}
 * @tool        tbl-class
 *
 * ⚠ AUTO-GENERATED - DO NOT EDIT
 */

PHP;
    }

    private function generateTblClass(array $tables): string
    {
        $content = "class Tbl\n{\n";

        foreach ($tables as $table) {
            $const = $this->namingResolver->getTableConstName($table, $this->mode);
            $content .= "    public const $const = '$table';\n";
        }

        return $content . "}\n\n";
    }

    private function generateTableClasses(array $tables): string
    {
        $content = '';

        // Buscar todas as foreign keys uma única vez
        $allFks = $this->getAllForeignKeys();

        foreach ($tables as $table) {

            // Nome da classe: Tbl + StudlyCase(table_name)
            $className = 'Tbl' . $this->tableClassName($table);

            $columns = $this->getColumns($table);
            $enums   = $this->getEnumConstants($table, false);

            // Filtrar FKs da tabela atual
            $fks = array_filter($allFks, fn($fk) => $fk['from_table'] === $table);

            $content .= "class {$className}\n{\n";

            // Columns
            foreach ($columns as $column) {
                $name = $this->namingResolver->getColumnConstName(null, $column, $this->mode);
                $content .= "    public const {$name} = '{$column}';\n";
            }

            // ENUMs
            if (!empty($enums)) {
                $content .= "\n    // ENUM values\n";
                foreach ($enums as $name => $value) {
                    $content .= "    public const enum_{$name} = '{$value}';\n";
                }
            }

            // Foreign Keys
            if (!empty($fks)) {
                $content .= "\n    // Foreign Keys\n";
                foreach ($fks as $fk) {
                    $fkName = $this->namingResolver->getForeignKeyConstName(
                        null,
                        $fk['to_table'],
                        $this->mode,
                        false
                    );
                    $content .= "    public const {$fkName} = '{$fk['from_column']}';\n";
                }
            }

            $content .= "\n    public const _TABLE = '{$table}';\n";
            $content .= "\n    public const _ALIAS = '{$this->namingResolver->getTableAlias($table)}';\n";
            $content .= "}\n\n";
        }

        return $content;
    }

    private function tableCLassName(string $table)
    {
        $tableName = $this->namingResolver->getTableConstName($table, $this->mode);
        return str_replace(
            ' ',
            '',
            ucwords(str_replace('_', ' ', $tableName))
        );
    }
}
