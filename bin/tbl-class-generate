#!/usr/bin/env php
<?php
// bin/tbl-class-generate

use Eril\TblSchemaSync\Generator;

// --- Help Text Display ---
$helpText = "
tbl-class-generate - CLI tool to generate the Tbl class constants from your MySQL schema.

Usage:
  tbl-class-generate <output_directory> -db <database_name>
  tbl-class-generate --check -db <database_name>
  tbl-class-generate

Options:
  <output_directory>      *Positional Argument*. Output directory where the 'Tbl.php' file will be saved.
  -db <name>              *Required*. The name of the database to read the schema from. Can be set via DB_NAME env var.
  --check                 Schema check mode. Compares MD5 hash of the current schema with the one saved in .tblschema/.tblsync.ini. Returns exit code 0 (OK) or 1 (CHANGE).

Examples:
  1. Generate the constants file:
     tbl-class-generate src/Helpers/ -db my_project_db

  2. Check if the schema has changed (ideal for CI/CD):
     tbl-class-generate --check -db my_project_db

  3. Show this help message:
     tbl-class-generate
";

// --- Argument Parsing and Logic ---

$args = $argv;
array_shift($args);

$output_dir = null;
$db_name = null;
$check_mode = false;

// Process positional argument and flags
foreach ($args as $index => $arg) {
    if ($arg === '--check') {
        $check_mode = true;
    } elseif ($arg === '-db' && isset($args[$index + 1])) {
        $db_name = $args[$index + 1];
    } elseif ($output_dir === null && $arg[0] !== '-') {
        // Assume o primeiro argumento que não é flag como diretorio de saida
        $output_dir = $arg;
    }
}


// --- 1. Validation and Help Display ---

// Se nenhum argumento foi passado, mostra o help
if (empty($argv) || count($argv) === 1) {
    echo $helpText;
    exit(0);
}

// Se está no modo de geração e o diretório não foi fornecido
if (!$check_mode && $output_dir === null) {
    die("❌ Error: Output directory must be provided as the first argument in generation mode.\nRun 'tbl-class-generate' for help.\n");
}


// --- 2. Autoload and Connection (Code remains the same) ---

$baseDir = __DIR__ . '/../'; 
$autoloadPath = $baseDir . 'vendor/autoload.php';

if (!file_exists($autoloadPath)) {
    die("❌ Error: Composer autoload file not found at $autoloadPath.\nEnsure the dependencies for the 'eril/tbl-schema-sync' package are installed.\n");
}
require_once $autoloadPath;

// ... (db_connection function definition remains here) ...

if (!function_exists('db_connection')) {
    // ... (db_connection definition with logic to handle DB_NAME env var) ...
    function db_connection(): PDO {
        $host = getenv('DB_HOST') ?: 'localhost';
        $db   = getenv('DB_NAME') ?: null; 
        $user = getenv('DB_USER') ?: 'root';
        $pass = getenv('DB_PASS') ?: '';
        $charset = 'utf8mb4';

        if ($db === null) {
             throw new \Exception("DB_NAME not defined. Use -db or environment variable.");
        }

        $dsn = "mysql:host=$host;dbname=$db;charset=$charset";
        $options = [
            PDO::ATTR_ERRMODE            => PDO::ERRMODE_EXCEPTION,
            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
            PDO::ATTR_EMULATE_PREPARES   => false,
        ];
        
        try {
            return new PDO($dsn, $user, $pass, $options);
        } catch (\PDOException $e) {
            throw new \Exception("PDO connection error: Failed to connect to database '{$db}'. Details: " . $e->getMessage());
        }
    }
}

// --- 3. Database Validation and Execution ---

// Set DB name from env if not provided
if ($db_name === null) {
    $db_name = getenv('DB_NAME') ?: 'unknown';
    if ($db_name === 'unknown') {
        die("❌ Error: Database name must be provided via -db or DB_NAME environment variable.\nRun 'tbl-class-generate' for help.\n");
    }
}

try {
    $pdo = db_connection(); 
} catch (Exception $e) {
    die("❌ Connection Error: " . $e->getMessage() . "\n");
}

try {
    // Note: $output_dir will be null in check mode, which is fine, 
    // as the Generator class only uses it in generation mode.
    $generator = new Generator($pdo, $db_name, $output_dir ?: './', $check_mode);
    $generator = new Generator($pdo, $db_name, $output_dir ?: './', $check_mode);
    $generator->run();
} catch (Exception $e) {
    die("❌ Execution Error: " . $e->getMessage() . "\n");
}