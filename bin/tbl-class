#!/usr/bin/env php
<?php
// bin/tbl-class

use Eril\TblClass\Config;
use Eril\TblClass\Resolvers\ConnectionResolver;
use Eril\TblClass\TableClassesGenerator;
use Eril\TblClass\TableClassGenerator;
use Eril\TblClass\GlobalGenerator;
use Eril\TblClass\SchemaClassGenerator;

// Definir apenas cores que serÃ£o usadas
define('COLOR_RESET', "\033[0m");
define('COLOR_RED', "\033[91m");      // Erros
define('COLOR_GREEN', "\033[92m");    // Sucesso
define('COLOR_YELLOW', "\033[93m");   // Avisos/Dicas
define('COLOR_BLUE', "\033[94m");     // InformaÃ§Ãµes
define('COLOR_CYAN', "\033[96m");     // Destaques
define('COLOR_WHITE', "\033[97m");    // Texto normal

// Estilos
define('STYLE_BOLD', "\033[1m");
define('STYLE_DIM', "\033[2m");

$quickHelp = "tbl-class - Generate database constants\n"
    . "Usage: tbl-class [<output>] [options]\n"
    . "       tbl-class --config\n"
    . "       tbl-class --check\n"
    . "       tbl-class --help\n";

$fullHelp = <<<HELP
tbl-class â€” Generate database table, column, and foreign key constants

Usage:
  tbl-class [<output>] [options]
  tbl-class --config
  tbl-class --check
  tbl-class --help

Arguments:
  <output>         Output directory (default: output.path from tblclass.yaml or current directory)

Options:
  --check          Compare current database schema with last generated state
                   Exit code: 0 = unchanged, 1 = changed
                   (Requires an accessible database schema)

  --global         Generate global constants (tbl_constants.php)

  --namespace=<ns> PHP namespace for the generated Tbl class

  --config         Show the resolved configuration file
                   (Generates a new one if it does not exist)

  --help           Show this help message

Examples:
  tbl-class
    Generate Tbl class using current configuration

  tbl-class src/Models
    Generate Tbl class into a custom directory

  tbl-class --global
    Generate global constants (tbl_constants.php)

  tbl-class --check
    Validate schema consistency against last generated state

  tbl-class --config
    Display the active configuration

Modes:
  Normal mode:
    Generates a Tbl class containing table, column, and foreign key constants

  Global mode:
    Generates global constants without a class wrapper

Notes:
  â€¢ tbl-class does not manage databases or migrations
  â€¢ An accessible database schema is required for generation and --check
  â€¢ Foreign keys are included automatically when detected
HELP;

// Parse args
$output = null;
$check = false;
$namespace = null;
$configFile = null;
$configMode = false;
$showHelp = false;
$globalMode = false;
$mode = 'classes';

for ($i = 1; $i < count($argv); $i++) {
    $arg = $argv[$i];

    if ($arg === '--help' || $arg === '-h') {
        $showHelp = true;
    } elseif ($arg === '--check') {
        $check = true;
    } elseif ($arg === '--global') {
        $globalMode = true;
        $mode = 'global';
    } elseif ($arg === '--legacy') {
        $globalMode = false;
        $mode = 'legacy';
    } elseif (str_starts_with($arg, '--namespace=')) {
        $namespace = substr($arg, 12);
    } elseif (str_starts_with($arg, '--config=')) {
        $configMode = true;
        $configFile = substr($arg, 9);
    } elseif ($arg === '--config') {
        $configMode = true;
    } elseif ($arg[0] !== '-') {
        $output = $arg;
    } else {
        echo COLOR_RED . "âœ– Unknown option: $arg" . COLOR_RESET . "\n\n";
        echo $quickHelp;
        exit(1);
    }
}

// Help se solicitado
if ($showHelp) {
    echo $fullHelp;
    exit(0);
}

// Autoload
$autoloadPaths = [
    __DIR__ . '/../vendor/autoload.php',
    __DIR__ . '/../../../autoload.php',
    dirname(__DIR__, 3) . '/autoload.php',
];

foreach ($autoloadPaths as $path) {
    if (file_exists($path)) {
        require_once $path;
        break;
    }
}

if (!class_exists('Eril\\TblClass\\Config')) {
    die(COLOR_RED . "âœ– Autoload not found. Run 'composer install' first." . COLOR_RESET . "\n");
}

// Config mode
if ($configMode) {
    $config = new Config($configFile);

    echo COLOR_CYAN . "âš™ Config file: " . $config->getConfigFile() . COLOR_RESET . "\n\n";

    if ($config->isNew()) {
        echo COLOR_GREEN . "âœ“ New config template created." . COLOR_RESET . "\n";
    }

    echo $config->exposeYaml();
    exit(0);
}

// Main execution
try {
    $config = new Config($configFile);

    if ($config->isNew()) {
        echo COLOR_YELLOW . STYLE_BOLD . "âœ¨ First run detected!" . COLOR_RESET . "\n";
        echo COLOR_GREEN . "âœ“ Config template created: " . $config->getConfigFile() . COLOR_RESET . "\n\n";

        echo COLOR_BLUE . "Please edit the config file with your database environment settings:" . COLOR_RESET . "\n";
        echo "1. Set 'database:name' (for MySQL) or 'database:path' (for SQLite)\n";
        echo STYLE_DIM . "   -- If you are using .env just use the env variables." . COLOR_RESET . "\n";
        echo STYLE_DIM . "   -- If you have an function or method that returns PDO use it in database:connection." . COLOR_RESET . "\n";
        echo "2. Adjust other settings as needed\n";
        echo "3. Run 'tbl-class' again\n\n";

        exit(0);
    }

    // Verificar configuraÃ§Ã£o bÃ¡sica
    $driver = $config->getDriver();
    $dbName = $config->getDatabaseName();
    $dbPath = $config->get('database.path');

    if ($driver === 'mysql' && empty($dbName)) {
        echo COLOR_RED . "âœ– MySQL requires 'database.name' to be set." . COLOR_RESET . "\n";
        echo COLOR_YELLOW . "Edit " . $config->getConfigFile() . " or use environment variables." . COLOR_RESET . "\n";
        exit(1);
    }

    if ($driver === 'sqlite' && empty($dbPath)) {
        echo COLOR_RED . "âœ– SQLite requires 'database.path' to be set." . COLOR_RESET . "\n";
        echo COLOR_YELLOW . "Edit " . $config->getConfigFile() . COLOR_RESET . "\n";
        exit(1);
    }

    // Aplicar opÃ§Ãµes CLI (se especificadas)
    if ($namespace) {
        $config->set('output.namespace', $namespace);
    }

    if ($output) {
        $config->set('output.path', $output);
    }

    // Conectar
    $pdo = ConnectionResolver::fromConfig($config);

    // Mensagem de conexÃ£o
    $driver = $config->getDriver();
    if ($driver === 'mysql') {
        $dbName = $config->getDatabaseName();
        echo COLOR_GREEN . "â†’ Connected to MySQL database: " . COLOR_CYAN . STYLE_BOLD . $dbName . COLOR_RESET . "\n";
    } else {
        $dbPath = $config->get('database.path');
        $dbFile = basename($dbPath);
        echo COLOR_GREEN . "â†’ Connected to SQLite database: " . COLOR_CYAN . STYLE_BOLD . $dbFile . COLOR_RESET . "\n";
    }

    // Determinar qual gerador usar
    if ($globalMode) {
        // Modo Global: Sempre inclui tabelas e FKs
        $generator = new GlobalGenerator($pdo, $config, $check);
        echo COLOR_BLUE . "âš™ Mode: Global constants (tables + foreign keys)" . COLOR_RESET . "\n";
    } else {
        // Modo Normal: Classe Tbl (com namespace se configurado)
        $generator = new TableClassesGenerator( $pdo, $config, $check);
        echo COLOR_BLUE . "âš™ Mode: TblClasses (tables + foreign keys + enums )" . COLOR_RESET . "\n";
    }

    $generator->run();
} catch (Exception $e) {
    echo COLOR_RED . STYLE_BOLD . "âœ– Error: " . $e->getMessage() . COLOR_RESET . "\n";

    $error = $e->getMessage();
    if (str_contains($error, 'DB_NAME') || str_contains($error, 'database name')) {
        echo "\n" . COLOR_YELLOW . "ðŸ’¡ Tip: Set 'database.name' in " . $config->getConfigFile() . ':11' . COLOR_RESET . "\n";
        echo "   Or use environment variable: export DB_NAME=your_database\n";
    } elseif (str_contains($error, 'connection failed')) {
        echo "\n" . COLOR_YELLOW . "ðŸ’¡ Tip: Check your database credentials in " . $config->getConfigFile() . '13' . COLOR_RESET . "\n";
        echo "   Make sure your database server is running.\n";
    }

    exit(1);
}
