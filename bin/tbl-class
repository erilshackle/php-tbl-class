#!/usr/bin/env php
<?php
// bin/tbl-class

use Eril\TblClass\Config;
use Eril\TblClass\ConnectionResolver;
use Eril\TblClass\TableClassGenerator;
use Eril\TblClass\GlobalGenerator;

$quickHelp = "tbl-class - Generate database constants\n"
    . "Usage: tbl-class [<output>] [options]\n"
    . "       tbl-class --config\n"
    . "       tbl-class --check\n"
    . "       tbl-class --help\n";

$fullHelp = <<<HELP
tbl-class - Generate database table constants

Usage:
  tbl-class [<output>] [options]
  tbl-class --config
  tbl-class --check
  tbl-class --help

Arguments:
  <output>        Output directory (default: current directory)

Options:
  --check         Check mode for CI/CD (exit 0=unchanged, 1=changed)
  --global        Generate global constants (tbl_constants.php)
  --namespace=<ns> PHP namespace for Tbl class
  --config         Show config file
  --help          Show this help

Examples:
  tbl-class                    # Generate Tbl class with namespace
  tbl-class --global          # Generate global constants
  tbl-class --check           # Check for schema changes
  tbl-class --config          # Show config file

Modes:
  Normal mode:     Creates a Tbl class in specified namespace
  Global mode:     Creates global constants (tbl_constants.php)

Note: Foreign keys are always included when found in database

HELP;

// Parse args
$output = null;
$check = false;
$namespace = null;
$configFile = null;
$configMode = false;
$showHelp = false;
$globalMode = false;

for ($i = 1; $i < count($argv); $i++) {
    $arg = $argv[$i];

    if ($arg === '--help' || $arg === '-h') {
        $showHelp = true;
    } elseif ($arg === '--check') {
        $check = true;
    } elseif ($arg === '--global') {
        $globalMode = true;
    } elseif (str_starts_with($arg, '--namespace=')) {
        $namespace = substr($arg, 12);
    } elseif (str_starts_with($arg, '--config=')) {
        $configMode = true;
        $configFile = substr($arg, 9);
    } elseif ($arg === '--config') {
        $configMode = true;
    } elseif ($arg[0] !== '-') {
        $output = $arg;
    } else {
        echo "âŒ Unknown option: $arg\n\n";
        echo $quickHelp;
        exit(1);
    }
}

// Help se solicitado
if ($showHelp) {
    echo $fullHelp;
    exit(0);
}

// Autoload
$autoloadPaths = [
    __DIR__ . '/../vendor/autoload.php',
    __DIR__ . '/../../../autoload.php',
    dirname(__DIR__, 3) . '/autoload.php',
];

foreach ($autoloadPaths as $path) {
    if (file_exists($path)) {
        require_once $path;
        break;
    }
}

if (!class_exists('Eril\\TblClass\\Config')) {
    die("âŒ Autoload not found. Run 'composer install' first.\n");
}

// Config mode
if ($configMode) {
    $config = new Config($configFile);

    echo "ðŸ“„ Config file: " . $config->getConfigFile() . "\n\n";

    if ($config->isNew()) {
        echo "âœ… New config template created.\n";
    }

    echo file_get_contents($config->getConfigFile());
    exit(0);
}

// Main execution
try {
    $config = new Config($configFile);

    if ($config->isNew()) {
        echo "âœ¨ First run detected!\n";
        echo "âœ… Config template created: " . $config->getConfigFile() . "\n\n";

        echo "Please edit the config file with your database environment settings:\n";
        echo "1. Set 'database:name' (for MySQL) or 'database:path' (for SQLite)\n";
        echo "   -- If you are using .env just use the env variables.\n";
        echo "   -- If you have an function or method that returns PDO use it in database:connection.\n";
        echo "2. Adjust other settings as needed\n";
        echo "3. Run 'tbl-class' again\n\n";

        exit(0);
    }

    // Verificar configuraÃ§Ã£o bÃ¡sica
    $driver = $config->getDriver();
    $dbName = $config->getDatabaseName();
    $dbPath = $config->get('database.path');

    if ($driver === 'mysql' && empty($dbName)) {
        echo "âŒ MySQL requires 'database.name' to be set.\n";
        echo "Edit " . $config->getConfigFile() . " or use environment variables.\n";
        exit(1);
    }

    if ($driver === 'sqlite' && empty($dbPath)) {
        echo "âŒ SQLite requires 'database.path' to be set.\n";
        echo "Edit " . $config->getConfigFile() . "\n";
        exit(1);
    }

    // Aplicar opÃ§Ãµes CLI (se especificadas)
    if ($namespace) {
        $config->set('output.namespace', $namespace);
    }

    if ($output) {
        $config->set('output.path', $output);
    }

    // Conectar
    $pdo = ConnectionResolver::fromConfig($config);

    // Mensagem de conexÃ£o
    $driver = $config->getDriver();
    if ($driver === 'mysql') {
        $dbName = $config->getDatabaseName();
        echo "ðŸ“¦ Connected to MySQL database: $dbName\n";
    } else {
        $dbPath = $config->get('database.path');
        $dbFile = basename($dbPath);
        echo "ðŸ“¦ Connected to SQLite database: $dbFile\n";
    }

    // Determinar qual gerador usar
    if ($globalMode) {
        // Modo Global: Sempre inclui tabelas e FKs
        $generator = new GlobalGenerator($pdo, $config, $check);
        echo "ðŸŒ Mode: Global constants (tables + foreign keys)\n";
    } else {
        // Modo Normal: Classe Tbl (com namespace se configurado)
        $generator = new TableClassGenerator($pdo, $config, $check);
        echo "ðŸ—ï¸  Mode: Tbl class (tables + foreign keys)\n";
    }

    $generator->run();
} catch (Exception $e) {
    echo "âŒ Error: " . $e->getMessage() . "\n";

    $error = $e->getMessage();
    if (str_contains($error, 'DB_NAME') || str_contains($error, 'database name')) {
        echo "\nðŸ’¡ Tip: Set 'database.name' in " . $config->getConfigFile() . ':11' .  "\n";
        echo "   Or use environment variable: export DB_NAME=your_database\n";
    } elseif (str_contains($error, 'connection failed')) {
        echo "\nðŸ’¡ Tip: Check your database credentials in " . $config->getConfigFile() . '13' . "\n";
        echo "   Make sure your database server is running.\n";
    }

    exit(1);
}
