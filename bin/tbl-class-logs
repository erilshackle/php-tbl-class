#!/usr/bin/env php
<?php
// bin/tbl-class-logs

use Eril\TblClass\Cli\CliPrinter;
use Eril\TblClass\Introspection\Logger;

include __DIR__ . "/../src/autoload.helper.php";

if (!class_exists('Eril\\TblClass\\Introspection\\Logger')) {
    die("âŒ Autoload not found.\n");
}

// Help text
$help = "tbl-class-logs - View Tbl-Class logs\n\n"
    . "Usage:\n"
    . "  tbl-class-logs          Show logs\n"
    . "  tbl-class-logs --clear  Clear logs\n"
    . "  tbl-class-logs --help   Show help\n";

// Parse arguments
$clear = false;
$showHelp = false;

foreach ($argv as $i => $arg) {
    if ($i === 0) continue; // Skip script name

    if ($arg === '--help' || $arg === '-h') {
        $showHelp = true;
    } elseif ($arg === '--clear') {
        $clear = true;
    } elseif ($arg[0] === '-') {
        echo "âŒ Unknown option: $arg\n\n";
        echo $help;
        exit(1);
    }
}

// Show help if requested
if ($showHelp) {
    echo $help;
    exit(0);
}

try {
    $logService = new Logger();
    $logFile = $logService->getLogPath();

    // Clear mode
    if ($clear) {
        if (file_exists($logFile)) {
            if (unlink($logFile)) {
                echo "âœ… Logs cleared\n";
            } else {
                echo "âŒ Cannot clear logs\n";
                exit(1);
            }
        } else {
            echo "ğŸ“­ No logs to clear\n";
        }
        exit(0);
    }

    // Check if log file exists
    if (!file_exists($logFile)) {
        echo "ğŸ“­ Log file is empty\n";
        exit(0);
    }

    CliPrinter::title("Reading Logs");
    
    // Read logs
    $content = file_get_contents($logFile);
    if ($content === false) {
        echo "âŒ Cannot read log file\n";
        exit(1);
    }

    // Check if empty
    $content = trim($content);
    if (empty($content)) {
        echo "ğŸ“­ Log file is empty\n";
        exit(0);
    }

    // Show logs
    CliPrinter::info($content . "\n");
    // echo $content . "\n";
} catch (Exception $e) {
    echo "âŒ Error: " . $e->getMessage() . "\n";
    exit(1);
}
